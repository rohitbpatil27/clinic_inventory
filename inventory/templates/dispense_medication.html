{% extends "base.html" %}

{% block title %}Dispense Medication{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="text-center">
                <h1 style="color: #ee9ca7;">Dispense Medication</h1>
                <p class="lead" style="color: #495057;">Select a patient and medications to dispense the required dosages.</p>
                <hr style="border: 1px solid #ffdde1;">
            </div>

            <!-- Dispense Medication Form -->
            <div class="card shadow-lg border-0 p-4">
                <h3 style="color: #ee9ca7;">Dispense Medications</h3>
                <form id="dispense-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="dispense_medication">
                    <div class="form-group mt-3">
                        <label for="patient" style="color: #495057;">Select Patient:</label>
                        <select name="patient_id" id="patient" class="form-control shadow-sm" required>
                            <option value="" disabled selected>Choose a patient</option>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="medication-fields">
                        <!-- Dynamic Medication Fields will be appended here -->
                    </div>

                    <button type="button" id="add-medication" class="btn btn-outline-primary mt-4">Add Medication</button>

                    <button type="submit" class="btn btn-primary btn-block mt-4" style="background-color: #ee9ca7; border: none;">Dispense Medications</button>
                </form>
                <div id="status-message" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Add Medication Input dynamically
    document.getElementById('add-medication').addEventListener('click', function() {
        const medicationFieldHTML = `
            <div class="form-group mt-3 medication-field">
                <label for="medication" style="color: #495057;">Select Medication:</label>
                <select name="medications[]" class="form-control shadow-sm" required>
                    <option value="" disabled selected>Choose a medication</option>
                    {% for medication in medications %}
                        <option value="{{ medication.id }}">{{ medication.name }} ({{ medication.quantity }} in stock)</option>
                    {% endfor %}
                </select>

                <label for="quantity" style="color: #495057;">Quantity:</label>
                <input type="number" name="quantities[]" class="form-control shadow-sm" min="1" required placeholder="Enter quantity" />
            </div>
        `;
        document.getElementById('medication-fields').insertAdjacentHTML('beforeend', medicationFieldHTML);
    });

    // Dispense Medication via AJAX
    document.getElementById('dispense-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append("action", "dispense_medication");

        fetch("", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value,
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            const statusMessage = document.getElementById("status-message");
            if (data.status === "success") {
                statusMessage.textContent = data.message;
                statusMessage.style.color = "green";

                // Optionally reset the form or update stock dynamically
                this.reset();
            } else {
                statusMessage.textContent = data.message;
                statusMessage.style.color = "red";
            }
        })
        .catch(error => {
            console.error("Error dispensing medications:", error);
        });
    });
</script>
{% endblock %}
